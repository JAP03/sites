PHTTP
72.21.91.9"็
:GET /web/js/tipping/tip.model_20140408023458.js HTTP/1.1
Host: edgecast.cam4s.com
Connection: keep-alive
Accept: */*
vUser-Agent: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/31.0.1650.63 Safari/537.36
Referer: http://www.cam4.com/
$Accept-Encoding: gzip,deflate,sdch
!Accept-Language: en-US,en;q=0.8

*ะม
HTTP/1.1 200 OK
Accept-Ranges: bytes
Cache-Control: max-age=604800
Content-Type: text/javascript
%Date: Tue, 08 Apr 2014 21:33:15 GMT
Etag: "1423789205"
(Expires: Tue, 15 Apr 2014 21:33:15 GMT
.Last-Modified: Tue, 08 Apr 2014 06:42:10 GMT
Server: ECS (ord/57F1)
X-Cache: HIT
Content-Length: 24451
ฟ
var TipDeltas={sendTipSampling:10,performer:{GHS_delta:1000,GHS_init:10000,GLT_init:5000,CS_tryAgain:2000,failureSampling:5,incrementAfterFailure:1000,watchDog:{restartAfter:20000,waitBeforeRestart:200,killPendingAt:20}},viewer:{getViewS_delta:1000,sessionGotFailureSampling:10,getViewS_init:1000,getLastTS_init:8000,getViewS_incrementOnFail:1000,getViewS_restoreFromFail:8000,getLastTS_incrementOnFail:1000},allowWatchDogDebug:function(){return(Math.round(Math.random()*100)===50);}};Array.prototype.allValuesSame=function(){if(this.length>0){for(var a=1;a<this.length;a++){if(this[a]!==this[0]){return false;}}}return true;};var Cam4Logs=Cam4Logs?Cam4Logs:{};Cam4Logs.consoleMode=false;Cam4Logs.logs=Cam4Logs.logs?Cam4Logs.logs:"";Cam4Logs.debug=function(c,d){var b=" ";if(typeof c=="object"||typeof c==="object"){b="   ";Cam4Logs.logs+=b+"[Object|Array] {\n";for(var a in c){Cam4Logs.logs+=b+' "'+a+'": "'+c[a]+'"\n';}Cam4Logs.logs+=b+"}\n";}else{Cam4Logs.logs+=b+c+"\n";}if(d){if(d.line){Cam4Logs.logs+=b+" at line "+d.line+"\n";}if(d.file){Cam4Logs.logs+=b+" in file "+d.file+"\n";}else{Cam4Logs.logs+=b+" rest: "+d+"\n";}}if(Cam4Logs.consoleMode){console.log(c);}};var TipSampler=function(){var a=new Array();var c=new Array();var b=TipDeltas.sendTipSampling;this.push=function(d){if(d>c[c.length-1]){var e=d-c[c.length-1];e=(e+"").charAt(0);e=parseInt(e);a.push(e);}c.push(d);return c;};this.allow=function(){var d=new Array();for(var e=a.length-1;e>a.length-b;e--){d.push(a[e]);}return !d.allValuesSame();};this.flush=function(){a=new Array();c=new Array();for(var d=0;d<b+1;d++){a.push(1);}a.push(new Date());};this.flush();};Array.min=function(a){return Math.min.apply(Math,a);};Array.max=function(a){return Math.max.apply(Math,a);};var TipCommunicator=new function(){var g=new TipSampler();var h="http://"+TIPPING_SERVER;var c=h+"/tipper/tipping.user.php";var e=h+"/tipper/tipping.class.php";this.getURL=function(){return h;};this.breakURL=function(){c="http://localhost/SheicProj/SheicPhp/tipping/tipper/tipping.user.php";e="http://localhost/SheicProj/SheicPhp/tipping/tipper/tipping.user.php";};this.restoreURL=function(){h="http://"+TIPPING_SERVER;c=h+"/tipper/tipping.user.php";e=h+"/tipper/tipping.class.php";};var i=this;var d={performerName:"undefined",viewerName:"undefined",webCdn:WEB_CDN?WEB_CDN:"",lang:Cam4User.lang?Cam4User.lang:"en",kN:0,iB:0};d.performerName=Cam4User.performerName;d.viewerName=Cam4User.userName;d.kN=Cam4User.kN;d.iB=Cam4User.iB;d.lang=Cam4User.lang;this.status={callsToGetUserSession:{total:0,times:[]},callsToGetLastTips:{total:0,times:[]},callsToGetHostSession:{total:0,times:[]},callsToCreateSession:{total:0,times:[]},callsToGetBalance:{total:0,times:[]}};this.getStatus=function(){function l(p){var n=new Object();var m=new Array();if(p.length>1){for(var o=1;o<p.length;o++){m.push(p[o]-p[o-1]);}n.maxDelay=Array.max(m);n.minDelay=Array.min(m);n.lastDelay=p[p.length-1].getTime()-p[p.length-2].getTime();}return n;}for(var k in this.status){this.status[k].rate=l(this.status[k].times);}return this.status;};this.destroy=function(){this.getUserSession=function(){};this.getLastTips=function(){};this.getHostSession=function(){};};this.setData=function(m,k,l,o,n){d.performerName=m;d.viewerName=k;d.kN=l;d.iB=o;if(n){d.lang=n;}Cam4Logs.debug(d,157);};this.removeScript=function(k){setTimeout(function(){try{k.root.removeChild(k.script);}catch(l){Cam4Logs.debug(l);}},200);};this.random=function(){return Math.random();};var j=false;var f=new Date("1985");this.getUserSession=function(n,r){var q='{"operation":"getUserSession","session_id":"'+n+'","model_id":"'+d.performerName+'","user_id":"'+d.viewerName+'","key":"'+d.kN+'","lang":"'+d.lang+'"}';var m=c+"?callback="+r+"&params="+q+"&zzz="+this.random();var o=ServiceTipViewer.getIntervals().getSessionIn;var l=new Date();var p=l.getTime()-f.getTime();if(p<o){Cam4Logs.debug("     >>>>>> you are trying to make a call to getUserSession in "+p+"ms rather than in "+o+" miliseconds");}f=l;if(Cam4User.isLoggedIn){this.status.callsToGetUserSession.total++;this.status.callsToGetUserSession.times.push(new Date());var k=Utils.injectJavascript(m,function(s){Cam4Logs.debug("getUserSession status: "+s,206);i.removeScript(k);},true);}else{if(!Cam4User.isLoggedIn&&!j){this.status.callsToGetUserSession.total++;this.status.callsToGetUserSession.times.push(new Date());var k=Utils.injectJavascript(m,function(s){Cam4Logs.debug("getUserSession status: "+s,206);i.removeScript(k);},true);j=true;}}return Cam4User.isLoggedIn;};this.sendTipAmmount=function(n,q,p){g.push(new Date());var l=q;l=parseInt(l);if(g.allow()){var o='{"operation":"sendTip","session_id":"'+n+'","model_id":"'+d.performerName+'","user_id":"'+d.viewerName+'","amount":"'+l+'","message":"","key":"'+d.kN+'","lang":"'+d.lang+'"}';var m=c+"?callback="+p+"&params="+o+"&zzz="+this.random();var k=Utils.injectJavascript(m,function(r){Cam4Logs.debug("send tip status: "+r,226);i.removeScript(k);},true);}else{Cam4Logs.debug("you are sending tips at same interval of time. Are you a human person?",231);g.flush();}};var b=new Date("1985");this.getLastTips=function(n,p,l){var o='{"operation":"getLastTipsJ","session_id":"'+n+'","model_id":"'+d.performerName+'","last_id":"'+p+'","key":"'+d.kN+'","lang":"'+d.lang+'"}';var k=c+"?callback="+l+"&params="+o+"&zzz="+this.random();var q=ServiceTipViewer.getIntervals().getSessionIn;if(Cam4User.userName==Cam4User.performerName){q=ServiceTipPerformer.getIntervals().lastTipsIn;}var m=new Date();var r=m-b;if(r<q){}b=m;if(Cam4User.isLoggedIn){this.status.callsToGetLastTips.total++;this.status.callsToGetLastTips.times.push(new Date());var s=Utils.injectJavascript(k,function(t){Cam4Logs.debug("getLastTips status: "+t,247);i.removeScript(s);},true);}};var a=new Date("1985");this.getHostSession=function(o,r){var q='{"operation":"getHostSession","session_id":"'+o+'","model_id":"'+d.performerName+'","key":"'+d.kN+'","lang":"'+d.lang+'"}';var m=e+"?callback="+r+"&params="+q+"&zzz="+this.random();var n=ServiceTipPerformer.getIntervals().hostHessionIn;var l=new Date();var p=l.getTime()-a.getTime();if(p<=n){}a=l;if(Cam4User.isLoggedIn){this.status.callsToGetHostSession.total++;this.status.callsToGetHostSession.times.push(new Date());var k=Utils.injectJavascript(m,function(s){Cam4Logs.debug("getHostSession status: "+s,260);i.removeScript(k);},true);}};this.setGoal=function(n,m,p){var o='{"operation":"setGoal","session_id":"'+n+'","model_id":"'+d.performerName+'","amount":"'+m+'","key":"'+d.kN+'","lang":"'+d.lang+'"}';var l=e+"?callback="+p+"&params="+o+"&zzz="+this.random();var k=Utils.injectJavascript(l,function(q){Cam4Logs.debug("setGoal status: "+q,272);i.removeScript(k);},true);};this.setMessage=function(m,n,p){var o='{"operation":"setMessage","session_id":"'+m+'","model_id":"'+d.performerName+'","message":"'+n+'","key":"'+d.kN+'","lang":"'+d.lang+'"}';var l=e+"?callback="+p+"&params="+o+"&zzz="+this.random();var k=Utils.injectJavascript(l,function(q){Cam4Logs.debug("setMessage status: "+q,283);i.removeScript(k);},true);};this.setTimeLimit=function(m,n,p){var o='{"operation":"setTimeLimit","session_id":"'+m+'","model_id":"'+d.performerName+'","deadline":"'+n+'","key":"'+d.kN+'","lang":"'+d.lang+'"}';var l=e+"?callback="+p+"&params="+o+"&zzz="+this.random();var k=Utils.injectJavascript(l,function(q){Cam4Logs.debug("setTimeLimit status: "+q,294);i.removeScript(k);},true);};this.createSession=function(n){var m='{"operation":"createSession","model_id":"'+d.performerName+'","key":"'+d.kN+'","lang":"'+d.lang+'"}';var l=e+"?callback="+n+"&params="+m+"&zzz="+this.random();if(Cam4User.isLoggedIn){this.status.callsToCreateSession.total++;this.status.callsToCreateSession.times.push(new Date());var k=Utils.injectJavascript(l,function(o){Cam4Logs.debug("createSession script status: "+o,305);i.removeScript(k);},true);}};this.getBalance=function(n){var m='{"operation":"getBalance","user_id":"'+d.viewerName+'","key":"'+d.kN+'","lang":"'+d.lang+'"}';var l=c+"?callback="+n+"&params="+m+"&zzz="+this.random();this.status.callsToGetBalance.total++;this.status.callsToGetBalance.times.push(new Date());var k=Utils.injectJavascript(l,function(o){Cam4Logs.debug("getBalance status: "+o,318);i.removeScript(k);},true);};this.sendOfflineTip=function(m,n,p){var o='{"operation":"sendOfflineTip","model_id":"'+d.performerName+'","user_id":"'+d.viewerName+'","amount":"'+m+'","message":"'+n+'","key":"'+d.kN+'","lang":"'+d.lang+'"}';var l=c+"?callback="+p+"&params="+o+"&zzz="+this.random();var k=Utils.injectJavascript(l,function(q){Cam4Logs.debug("sendOfflineTip status: "+q,330);i.removeScript(k);},true);};this.getData=function(){return d;};this.killPending=function(){try{window.stop();}catch(l){try{window.document.execCommand("Stop");}catch(k){try{}catch(k){document.execCommand("Stop");}}}};this.getLogs=function(){return logs;};};var ServiceTipPerformer=new function(){var o=TipCommunicator;var a="";var g="";var q=this;Cam4Logs.debug("              SERVICE TIP PERFORMER instance created");this.wrapperInstanceName="tipping";this.instanceName="service";this.getMethod=function(E){return"ServiceTipPerformer."+E;};var y=new Array();var x=new Array();var l=new Array();var n=new Array();var u=new Array();var D=new Array();var d=new Array();var b=false;var f=false;var w="";var A="";var v=TipDeltas.performer.GHS_init;var z=TipDeltas.performer.GLT_init;var t="";this.getIntervals=function(){return{hostHessionIn:v,lastTipsIn:z};};function C(G,F){for(var E=0;E<G.length;E++){G[E](F);}}var c=0;var m=TipDeltas.performer.CS_tryAgain;var k="";function j(){c++;clearTimeout(k);clearTimeout(w);clearTimeout(A);if(c>TipDeltas.performer.failureSampling){m+=TipDeltas.performer.incrementAfterFailure;Cam4Logs.debug("more than 5 errors, down to ..."+m);}k=setTimeout(function(){r();},m);}function r(){Cam4Logs.debug("SERVICE TIP PERFORMER createSession:");clearTimeout(k);clearTimeout(w);clearTimeout(A);o.createSession(q.getMethod("sessionCreated"));}this.sessionCreated=function(E){Cam4Logs.debug("s- session created");Cam4Logs.debug(E);if(E){if(E.session_id){if(E.status){if(E.status>=0){a=E.session_id;C(l,E);B();p();f=true;m=TipDeltas.performer.CS_tryAgain;}else{if(E.status==-2){Cam4Logs.debug(" die, SHOULD REFRESH BROWSER");j();}else{if(E.status==-1){Cam4Logs.debug("status =  "+E.status);m=TipDeltas.performer.CS_tryAgain;j();}}}}else{Cam4Logs.debug("s- session created no status");j();}}else{Cam4Logs.debug("s- no session_id generated");j();}}else{Cam4Logs.debug(" die, no args SHOULD REFRESH BROWSER <<< ");j();}};function B(){clearTimeout(w);if(b){o.getHostSession(a,q.getMethod("hostSessionGot"));}else{console.log(" Service not started");}}this.getSessionOnce=function(){if(f&&!b){console.log("getSessionOnce");Cam4Logs.debug("public ServicePerformer.getSessionOnce... get");o.getHostSession(a,q.getMethod("sessionOnceGot"));o.getLastTips(a,g,q.getMethod("lastTipsOnceGot"));return true;}return true;};this.sessionOnceGot=function(E){Cam4Logs.debug("sessionOnceGot");var G={};for(var F in E){if(F!=="f"&&F!=="session_id"){G[F]=E[F];}}C(y,G);};this.lastTipsOnceGot=function(E){Cam4Logs.debug("lastTipsOnceGot");var G={};for(var F in E){G[F]=E[F];}C(x,G);};this.hostSessionGot=function(E){clearTimeout(w);if(E){Cam4Logs.debug("s- host session got");Cam4Logs.debug(E);if(E.session_id){a=E.session_id;if(E.status){if(E.f){v=(parseInt(E.f)*TipDeltas.performer.GHS_delta);}if(E.status==-1){Cam4Logs.debug("s- hostSessionGot status -1, try again create session");j();return;}else{if(E.status==-2){Cam4Logs.debug("s- hostSessionGot status -2, REFRESH BROWSER");j();return;}else{if(E.status>=0){m=30000;var G={};for(var F in E){if(F!=="f"&&F!=="session_id"){G[F]=E[F];}}C(y,G);if(b){w=setTimeout(B,v);}}else{Cam4Logs.debug("s- hostSessionGot status is not numeric, REFRESH BROWSER");j();return;}}}}else{Cam4Logs.debug("s- hostSessionGot no status, REFRESH BROWSER");j();}}else{Cam4Logs.debug("s- hostSessionGot no session_id try again create session");j();}}else{Cam4Logs.debug("s- hostSessionGot NO RESPONSE REFRESH BROWSER");j();}};var i="";function p(){clearTimeout(A);if(q.hasSession()&&b){o.getLastTips(a,g,q.getMethod("lastTipsGot"));}else{if(b){i=setTimeout(p,1000);}else{clearTimeout(i);}}}this.lastTipsGot=function(E){Cam4Logs.debug("s- lastTipsGot");clearTimeout(A);if(E){if(E.last_id){g=E.last_id;}var G={};for(var F in E){G[F]=E[F];}C(x,G);if(b&&this.hasSession()){A=setTimeout(p,z);}}else{Cam4Logs.debug("s- lastTipsGot called without arguments");clearTimeout(A);}};this.setTimeLimit=function(E){o.setTimeLimit(a,E,this.getMethod("timeLimitSet"));};this.lastMessageSet="";this.setMessage=function(E){this.lastMessageSet=E;o.setMessage(a,E,this.getMethod("messageSet"));};this.setGoal=function(E){o.setGoal(a,E,this.getMethod("goalSetted"));};this.messageSet=function(E){if(E){if(E.badword){if(Cam4User.userId){JSClient.statusMessageCensoredWord(Cam4User.userId,E.badword);}}if(E.status){if(E.status>=0){Cam4Logs.debug("s- messageSet");Cam4Logs.debug(E);C(d,E);}}}};this.timeLimitSet=function(E){if(E){if(E.status){if(E.status>=0){Cam4Logs.debug("s- timeLimitSet");Cam4Logs.debug(E);C(D,E);}}}};this.goalSetted=function(E){Cam4Logs.debug("s- goal setted");Cam4Logs.debug(E);if(E){if(E.status){if(E.status>=0){C(u,E);}}}};this.start=function(){if(!b&&Cam4User.isLoggedIn){b=true;Cam4Logs.debug("Service PERFORMER STARTED: "+b);clearTimeout(w);clearTimeout(A);clearInterval(t);clearTimeout(i);m=TipDeltas.performer.CS_tryAgain;if(!this.hasSession()){Cam4Logs.debug("start with create session");r();}else{Cam4Logs.debug("start with get host session");B();p();}s=0;t=setInterval(h,100);}};this.stop=function(){b=false;clearTimeout(w);clearTimeout(A);clearInterval(t);clearTimeout(i);s=0;Cam4Logs.debug("Service PERFORMER STOPPED: "+!b);};var e=TipDeltas.performer.watchDog.restartAfter;var s=0;function h(){if(TipCommunicator.getStatus().callsToGetHostSession.times.length>1){var G=new Date();var E=TipCommunicator.getStatus().callsToGetHostSession.times[TipCommunicator.getStatus().callsToGetHostSession.times.length-1];var F=G.getTime()-E.getTime();if(F>e){s++;if(s>(TipDeltas.performer.watchDog.killPendingAt/2)&&s<TipDeltas.performer.watchDog.killPendingAt){TipCommunicator.killPending();Cam4Logs.debug("kill pending... "+s);}if(s>TipDeltas.performer.watchDog.waitBeforeRestart){q.stop();q.start();s=0;}if(TipDeltas.allowWatchDogDebug()){Cam4Logs.debug("wait "+s+"/"+TipDeltas.performer.watchDog.waitBeforeRestart);}}else{if(TipDeltas.allowWatchDogDebug()){Cam4Logs.debug("watchdog is running, timeFromLastCall = "+F+" from max of "+e);}}}else{if(!q.hasSession()){s++;if(TipDeltas.allowWatchDogDebug()){Cam4Logs.debug("watchdog found no session at "+new Date()+"  wait "+s+" / "+TipDeltas.performer.watchDog.waitBeforeRestart);}if(s>TipDeltas.performer.watchDog.waitBeforeRestart){q.stop();q.start();s=0;}}}}this.onTimeLimitSet=function(E){D.push(E);};this.onMessageSet=function(E){d.push(E);};this.onGoalSetted=function(E){u.push(E);};this.onSessionCreated=function(E){l.push(E);};this.onHostSessionGot=function(E){y.push(E);};this.onLastTipsGot=function(E){x.push(E);};this.onError=function(E){n.push(E);};this.hasSession=function(){return(typeof a!="undefined")&&(a!=="");};this.getSessionId=function(){return a;};this.isRunning=function(){return b;};this.removeEventListeners=function(){y=new Array();x=new Array();l=new Array();n=new Array();u=new Array();D=new Array();d=new Array();return true;};};var DaemonVersioning=new function(){this.serverURL="http://199.59.88.52:35000";this.breakURL=function(){this.serverURL="http://localhost/";};this.restoreURL=function(){this.serverURL="http://199.59.88.52:35000";};var c="";var a=this;var g=false;var d=false;var b="";this.update=function(){var h=a.serverURL+"/Vu"+c;Cam4Logs.debug("ajax UPDATE to "+h+" at"+new Date());if(c!=""){AjaxSender.send({method:"post",url:h,success:function(i){a.updateFinished(i);},onerror:function(i){Cam4Logs.debug(i);ServiceTipViewer.useVersioning=false;a.updateFinished("error");},onexception:function(i){Cam4Logs.debug(i);ServiceTipViewer.useVersioning=false;a.updateFinished("exception");}});}};var e="strNpos";this.updateFinished=function(i){var h=(e==i);if(!i||isNaN(i)||i==="error"||i==="exception"||h){ServiceTipViewer.useVersioning=false;d=false;clearTimeout(b);console.log("daemon stopped due to some errors in update action");this.onUpdate(i);this.onUpdate=function(){};}else{d=true;}};this.read=function(){var h=a.serverURL+"/Vr"+c+"."+Cam4User.userName;if(c!=""&&d){Cam4Logs.debug("ajax READ to "+h+" at "+new Date());AjaxSender.send({method:"post",url:h,success:function(i){a.readFinished(i);},onerror:function(i){console.log(i);ServiceTipViewer.useVersioning=false;clearTimeout(b);a.readFinished("error");},onexception:function(i){console.log(i);ServiceTipViewer.useVersioning=false;clearTimeout(b);a.readFinished("exception");}});}else{Cam4Logs.debug("no update made, try again in 100 miliseconds");b=setTimeout(function(){a.read();},100);}};var f=-9999;this.readFinished=function(h){if(!g||!h||h==="error"||h==="exception"||isNaN(h)){ServiceTipViewer.useVersioning=false;Cam4Logs.debug("daemon stopped due to some errors at index="+h+" because versioningStarted = "+g);this.onUpdate(h);this.onUpdate=function(){};return;}if(h!==f){Cam4Logs.debug("read update ... "+h+"/"+f);this.onUpdate(h);if(h>0){f=h;}}else{Cam4Logs.debug("read wait ... "+h+"/"+f);}if(g&&h!=="error"&&h!=="exception"){b=setTimeout(function(){a.read();},8000);}else{ServiceTipViewer.useVersioning=false;this.onUpdate(h);this.onUpdate=function(){};return;}};this.setSessionId=function(h){c=h;Cam4Logs.debug("update session_id in Daemon");if(g===false&&ServiceTipViewer.hasSession()){g=true;this.update();this.read();Cam4Logs.debug("VERSIONING STARTED SUCCESSFUL");return true;}return false;};this.stop=function(){};this.onUpdate=function(h){};};var ServiceTipViewer=new function(){var r=TipCommunicator;this.useVersioning=false;Cam4Logs.debug("              SERVICE TIP VIEWER instance ");var a="";var h="";var t=this;var k=new Array();var v=new Array();var u=new Array();var p=new Array();var j="";var n=0;var g=0;this.wrapperInstanceName="ncTip";this.instanceName="service";var o="";var q=TipDeltas.viewer.getViewS_init;var e="";var f=TipDeltas.viewer.getLastTS_init;this.getIntervals=function(){return{getUserSession:q,getLastTips:f};};this.getIntervals=function(){return{getSessionIn:q,lastTipsIn:f};};var b=false;var x=true;var m=true;function B(E,D){for(var C=0;C<E.length;C++){E[C](D);}}var A=0;function l(C){Cam4Logs.debug("check status"+C);if(C>=0){A=0;}else{if(C==-1){B(p,{message:"no tokens in balance",description:"no_more_tokens"});}else{if(C==-2){A++;q=q+TipDeltas.viewer.getViewS_incrementOnFail;f=f+TipDeltas.viewer.getLastTS_incrementOnFail;console.log(q+" downing to..."+f);B(p,{message:nstiplang.errors.serverConnectionError,description:"response status -2"});if(A>10){console.log(" fatalErrors > 10, closing calls");r.destroy();t.stop();}}}}}var d={userbalance:"",message:"",goal:"0",goalbalance:"0",deadline:"",crtbalance:0,tlamount:0,toptipper:"",status:""};var z={response:"",tippers:[],status:""};var i="undefined";this.start=function(){if(!b&&Cam4User.isLoggedIn){this.stop();b=true;m=true;x=true;w();s();}else{if(!b&&!Cam4User.isLoggedIn){this.getSessionOnce();b=true;}}};this.getMethod=function(C){return"ServiceTipViewer."+C;};this.sendTip=function(C){if(b){r.sendTipAmmount(a,C,this.getMethod("tipSent"));if(this.useVersioning){console.log("Daemon update:");DaemonVersioning.update();}}};this.tipSent=function(C){if(C){if(C.status){l(C.status);}else{B(p,{message:nstiplang.errors.serverConnectionError,description:"missing status from server in tipSent"});}}else{B(p,{message:nstiplang.errors.serverConnectionError,description:"missing response from server in tipSent"});}i.tipSentArgs=C;B(u,C);};function s(){if(a!==""){g++;Cam4Logs.debug("totalCallsToLastTips = "+g);if(b){r.getLastTips(a,h,t.getMethod("lastTipsGot"));}else{g--;}return true;}else{if(b&&m){e=setTimeout(s,f);}}return false;}this.lastTipsGot=function(C){console.log("last tips got",C);z.tippers=new Array();if(C){if(C.status){l(C.status);}else{B(p,{message:nstiplang.errors.serverConnectionError,description:"missing status from server in lastTipsGot"});}if(C.last_id&&C.last_id!==""){h=C.last_id;}if(C.response){z.response=C.response;}if(C.tips){z.tippers=C.tips;}if(C.status){z.status=C.status;}}else{B(p,{message:nstiplang.errors.serverConnectionError,description:"missing response from server in lastTipsGot"});}if(b&&m&&Cam4User.isLoggedIn){Cam4Logs.debug("next call to getLastTips in "+f+" seconds");e=setTimeout(s,f);}i.lastTipsReponseForViewer=z;B(v,z);};function w(){if(b){n++;r.getUserSession(a,t.getMethod("sessionGot"));Cam4Logs.debug("totalCallsToSession = "+n);}}DaemonVersioning.onUpdate=function(C){w();};this.getSessionOnce=function(){n++;r.getUserSession(a,t.getMethod("sessionGotOnce"));return true;};this.sessionGotOnce=function(C){console.log("session got once",C);if(C){if(C.session_id){a=C.session_id;}for(var D in C){if(D!=="session_id"&&D!=="f"&&C[D]!==null){d[D]=C[D];}}B(k,d);i.sessionResponseForViewer=d;}};var c=0;var y=-999;this.sessionGot=function(C){if(C){if(C.session_id){a=C.session_id;}else{c++;Cam4Logs.debug("session_id failed "+c);if(c>TipDeltas.viewer.sessionGotFailureSampling){q+=TipDeltas.viewer.getViewS_incrementOnFail;}Cam4Logs.debug("missing session id from server in sessionGot");B(p,{message:nstiplang.errors.serverConnectionError,description:"missing session id from server in sessionGot"});}if(C.status){if(C.status==-2){console.log("Viewer DIE, REFRESH BROWSER");B(p,{message:nstiplang.errors.serverConnectionError,description:"missing status from server in sessionGot"});return;}}if(C.last_id){clearTimeout(e);m=false;if(C.last_id>y){Cam4Logs.debug("last_id received: "+C.last_id+" kill looping");y=C.last_id;s();}}if(C.f){if(parseFloat(C.f)!==parseFloat(q)){q=parseFloat(C.f)*TipDeltas.viewer.getViewS_delta;}}if(C.userbalance&&parseInt(C.userbalance)>=0){j=C.userbalance;}for(var D in C){if(D!=="session_id"&&D!=="f"&&C[D]!==null){d[D]=C[D];}}}else{q=TipDeltas.viewer.getViewS_restoreFromFail;Cam4Logs.debug("missing response from server in sessionGot");B(p,{message:nstiplang.errors.serverConnectionError,description:"missing response from server in sessionGot"});}B(k,d);i.sessionResponseForViewer=d;if(this.useVersioning&&b&&x&&Cam4User.isLoggedIn&&this.hasSession()){console.log("service is using versiuoning system, getViewerSession will be called by daemon");DaemonVersioning.setSessionId(a);return;}else{if(b&&x&&Cam4User.isLoggedIn){Cam4Logs.debug("NO VERSIONING : next call to getViewerSession in "+q+" seconds");o=setTimeout(w,q);}else{this.stop();}}};this.stop=function(C){if(!b){console.log("service viewer already stopped");}else{console.log("stopping service viewer");}if(C){switch(C){case"getSession":clearTimeout(o);x=false;return;break;case"getLastTips":clearTimeout(e);m=false;break;}}else{clearTimeout(o);clearTimeout(e);x=false;m=false;}DaemonVersioning.stop();b=false;};this.removeEvent=function(D,C){switch(D){case"onSessionGot":if(C){k.slice(C,1);}else{k=new Array();}break;case"onLastTipsGot":v.slice(C,1);break;case"onTipSent":u.slice(C,1);break;case"onError":p.slice(C,1);break;}};this.removeEventListeners=function(){k=new Array();v=new Array();u=new Array();p=new Array();return true;};this.onSessionGot=function(C){if(C){k.push(C);return k.length;}else{return{remove:function(D){k.slice(D,1);}};}};this.clearSession=function(){a="";};this.onLastTipsGot=function(C){v.push(C);};this.onTipSent=function(C){u.push(C);};this.onError=function(C){p.push(C);};this.getCommunicator=function(){return r;};this.hasSession=function(){return(typeof a!="undefined"&&a!==""&&a!="null"&&a!="undefined");};this.hasBalance=function(){return j!=="";};this.getSomeRespone=function(){return i;};this.getSessionId=function(){return a;};this.isRunning=function(){return b;};};var TipFactory={getViewerService:function(a){return ServiceTipViewer;},popTokens:function(){Utils.safePopUp("/checkout/tokens",680,700);},swicthV_OldWithNew:function(){document.getElementById("widgetWrap").style.display="none";tipping.kill();$j("#tippingDiv").hide();$j("#newTipAreaMain").show();ncTip=new TipWatcher();ncTip.init();},swicthV_NewWithOld:function(){document.getElementById("widgetWrap").style.display="block";$j("#tippingDiv").show();$j("#newTipAreaMain").hide();try{ncTip.close();}catch(a){}tipping.ST();},};